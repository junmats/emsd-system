<div class="students-container">
  <!-- Student Management Section -->
  <div class="card">
    <div class="card-header">
      <h5 class="mb-0 d-flex align-items-center">
        All Students
        <span class="badge bg-primary ms-2">{{ filteredStudents.length }}</span>
      </h5>
    </div>

    <div class="card-body">
      <!-- Filters and Search -->
      <div class="row mb-4">
        <div class="col-md-4">
          <label for="searchInput" class="form-label">Search Students</label>
          <input type="text" class="form-control" id="searchInput" placeholder="Search by name or student ID..." 
                 [(ngModel)]="searchTerm" (input)="onSearchChange()">
        </div>
        <div class="col-md-2">
          <label for="gradeFilter" class="form-label">Grade Level</label>
          <select class="form-select" id="gradeFilter" [(ngModel)]="selectedGradeFilter" (change)="applyFilters()">
            <option value="">All Grades</option>
            <option *ngFor="let grade of gradeLevels" [value]="grade">Grade {{ grade }}</option>
          </select>
        </div>
        <div class="col-md-2">
          <label for="statusFilter" class="form-label">Status</label>
          <select class="form-select" id="statusFilter" [(ngModel)]="selectedStatusFilter" (change)="applyFilters()">
            <option value="">All Status</option>
            <option value="active">Active</option>
            <option value="inactive">Inactive</option>
            <option value="graduated">Graduated</option>
          </select>
        </div>
        <div class="col-md-4">
          <label class="form-label">&nbsp;</label>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" (click)="clearFilters()">
              Clear Filters
            </button>
            <button class="btn btn-primary" (click)="openAddModal()">
              Add Student
            </button>
          </div>
        </div>
      </div>

      <!-- Bulk Actions Bar -->
      <div *ngIf="showBulkActions" class="alert alert-info d-flex justify-content-between align-items-center mb-4">
        <div>
          <strong>{{ selectedStudents.size }}</strong> student(s) selected
        </div>
        <div class="btn-group" role="group">
          <button class="btn btn-sm btn-outline-secondary" (click)="clearSelection()">
            Clear Selection
          </button>
          <button class="btn btn-sm btn-outline-success" 
                  (click)="bulkUpgrade()" 
                  [disabled]="bulkUpgrading">
            <span *ngIf="bulkUpgrading" class="spinner-border spinner-border-sm me-2"></span>
            {{ bulkUpgrading ? 'Upgrading...' : 'Upgrade Selected' }}
          </button>
          <button class="btn btn-sm btn-outline-danger" 
                  (click)="bulkDelete()" 
                  [disabled]="bulkDeleting">
            <span *ngIf="bulkDeleting" class="spinner-border spinner-border-sm me-2"></span>
            {{ bulkDeleting ? 'Deleting...' : 'Delete Selected' }}
          </button>
        </div>
      </div>

      <!-- Loading State -->
      <div *ngIf="loading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Loading...</span>
        </div>
        <p class="mt-2 text-muted">Loading students...</p>
      </div>

      <!-- Error State -->
      <div *ngIf="error && !loading" class="alert alert-danger" role="alert">
        {{ error }}
        <button class="btn btn-sm btn-outline-danger ms-2" (click)="loadStudents()">
          Retry
        </button>
      </div>

      <!-- No Students Message -->
      <div *ngIf="!loading && !error && filteredStudents.length === 0" class="text-center py-5">
        <h5 class="text-muted">No Students Found</h5>
        <p class="text-muted">
          <span *ngIf="!searchTerm && !selectedGradeFilter && !selectedStatusFilter">No students are currently enrolled in the system.</span>
          <span *ngIf="searchTerm || selectedGradeFilter || selectedStatusFilter">No students match the current filters. Try adjusting your search criteria.</span>
        </p>
      </div>

      <!-- Students List -->
      <div *ngIf="!loading && !error && filteredStudents.length > 0" class="students-list">
        <div class="row">
          <div class="col-12">
            <div class="table-responsive">
              <table class="table table-hover">
                <thead class="table-light">
                  <tr>
                    <th scope="col" style="width: 50px;">
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               [checked]="selectAll" 
                               (change)="toggleSelectAll()"
                               id="selectAllCheckbox">
                        <label class="form-check-label" for="selectAllCheckbox">
                          <span class="visually-hidden">Select All</span>
                        </label>
                      </div>
                    </th>
                    <th scope="col">
                      Name
                    </th>
                    <th scope="col">
                      Student ID
                    </th>
                    <th scope="col">
                      Grade Level
                    </th>
                    <th scope="col">
                      Enrollment Date
                    </th>
                    <th scope="col">
                      Status
                    </th>
                    <th scope="col">
                      Actions
                    </th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let student of filteredStudents; trackBy: trackByStudentId">
                    <td>
                      <div class="form-check">
                        <input class="form-check-input" type="checkbox" 
                               [checked]="isStudentSelected(student.id)" 
                               (change)="toggleStudentSelection(student.id)"
                               [id]="'student-checkbox-' + student.id">
                        <label class="form-check-label" [for]="'student-checkbox-' + student.id">
                          <span class="visually-hidden">Select {{ getStudentFullName(student) }}</span>
                        </label>
                      </div>
                    </td>
                    <td>
                      <div class="student-name">
                        <strong>{{ getStudentFullName(student) }}</strong>
                        <small class="text-muted d-block" *ngIf="student.parent_name">
                          Parent: {{ student.parent_name }}
                        </small>
                      </div>
                    </td>
                    <td>
                      <span class="badge bg-secondary">{{ student.student_number }}</span>
                    </td>
                    <td>
                      <span class="badge bg-primary">Grade {{ student.grade_level }}</span>
                    </td>
                    <td class="text-muted">
                      {{ formatDate(student.enrollment_date) }}
                    </td>
                    <td>
                      <span class="badge" 
                            [class.bg-success]="student.status === 'active'"
                            [class.bg-warning]="student.status === 'inactive'"
                            [class.bg-secondary]="student.status === 'graduated'">
                        {{ student.status | titlecase }}
                      </span>
                    </td>
                    <td>
                      <div class="btn-group" role="group">
                        <button class="btn btn-sm btn-outline-primary" 
                                title="View Details"
                                (click)="openViewModal(student)">
                          View
                        </button>
                        <button class="btn btn-sm btn-outline-secondary" 
                                title="Edit Student"
                                (click)="openEditModal(student)">
                          Edit
                        </button>
                        <button class="btn btn-sm btn-outline-success" 
                                title="{{ student.grade_level === 6 ? 'Graduate Student' : 'Upgrade to Grade ' + (student.grade_level + 1) }}"
                                (click)="openUpgradeModal(student)"
                                *ngIf="student.status === 'active'">
                          <i class="fas fa-arrow-up"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger" 
                                title="Delete Student"
                                (click)="openDeleteModal(student)">
                          Delete
                        </button>
                      </div>
                    </td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Upgrade/Graduate Confirmation Modal -->
<div class="modal fade" [class.show]="showUpgradeModal" [style.display]="showUpgradeModal ? 'block' : 'none'" *ngIf="showUpgradeModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ selectedStudent?.grade_level === 6 ? 'Graduate Student' : 'Upgrade Grade Level' }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedStudent">
        <p class="text-center">
          <span *ngIf="selectedStudent.grade_level < 6">
            Upgrade <strong>{{ getStudentFullName(selectedStudent) }}</strong> from 
            <strong>Grade {{ selectedStudent.grade_level }}</strong> to 
            <strong>Grade {{ selectedStudent.grade_level + 1 }}</strong>?
          </span>
          <span *ngIf="selectedStudent.grade_level === 6">
            Graduate <strong>{{ getStudentFullName(selectedStudent) }}</strong> from 
            <strong>Grade {{ selectedStudent.grade_level }}</strong>?
            <br><small class="text-muted">This will change their status to "Graduated"</small>
          </span>
        </p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-success" (click)="confirmUpgrade()" [disabled]="submitting">
          <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
          <i *ngIf="!submitting" class="fas fa-check me-2"></i>
          {{ submitting ? 'Processing...' : (selectedStudent?.grade_level === 6 ? 'Graduate' : 'Upgrade') }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Add Student Modal -->
<div class="modal fade" [class.show]="showAddModal" [style.display]="showAddModal ? 'block' : 'none'" *ngIf="showAddModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Add New Student
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="studentNumber" class="form-label">Student Number *</label>
              <input type="text" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['student_number']"
                     id="studentNumber" 
                     [(ngModel)]="formStudent.student_number" 
                     name="studentNumber" 
                     required>
              <div class="invalid-feedback" *ngIf="formErrors['student_number']">
                {{ formErrors['student_number'] }}
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label for="firstName" class="form-label">First Name *</label>
              <input type="text" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['first_name']"
                     id="firstName" 
                     [(ngModel)]="formStudent.first_name" 
                     name="firstName" 
                     required>
              <div class="invalid-feedback" *ngIf="formErrors['first_name']">
                {{ formErrors['first_name'] }}
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label for="middleName" class="form-label">Middle Name</label>
              <input type="text" 
                     class="form-control" 
                     id="middleName" 
                     [(ngModel)]="formStudent.middle_name" 
                     name="middleName">
            </div>
            <div class="col-md-4 mb-3">
              <label for="lastName" class="form-label">Last Name *</label>
              <input type="text" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['last_name']"
                     id="lastName" 
                     [(ngModel)]="formStudent.last_name" 
                     name="lastName" 
                     required>
              <div class="invalid-feedback" *ngIf="formErrors['last_name']">
                {{ formErrors['last_name'] }}
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="gradeLevel" class="form-label">Grade Level *</label>
              <select class="form-select" 
                      [class.is-invalid]="formErrors['grade_level']"
                      id="gradeLevel" 
                      [(ngModel)]="formStudent.grade_level" 
                      name="gradeLevel" 
                      required>
                <option *ngFor="let grade of gradeLevels" [value]="grade">Grade {{ grade }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="formErrors['grade_level']">
                {{ formErrors['grade_level'] }}
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="enrollmentDate" class="form-label">Enrollment Date *</label>
              <input type="date" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['enrollment_date']"
                     id="enrollmentDate" 
                     [(ngModel)]="formStudent.enrollment_date" 
                     name="enrollmentDate" 
                     required>
              <div class="invalid-feedback" *ngIf="formErrors['enrollment_date']">
                {{ formErrors['enrollment_date'] }}
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="dateOfBirth" class="form-label">Date of Birth</label>
              <input type="date" class="form-control" id="dateOfBirth" [(ngModel)]="formStudent.date_of_birth" name="dateOfBirth">
            </div>
            <div class="col-md-6 mb-3">
              <label for="status" class="form-label">Status</label>
              <select class="form-select" id="status" [(ngModel)]="formStudent.status" name="status">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="graduated">Graduated</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="address" class="form-label">Address</label>
              <input type="text" class="form-control" id="address" [(ngModel)]="formStudent.address" name="address">
            </div>
          </div>
          <hr class="my-4">
          <h6 class="text-muted mb-3">Parent/Guardian Information</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="parentName" class="form-label">Parent/Guardian Name</label>
              <input type="text" class="form-control" id="parentName" [(ngModel)]="formStudent.parent_name" name="parentName">
            </div>
            <div class="col-md-6 mb-3">
              <label for="parentContact" class="form-label">Parent Contact</label>
              <input type="text" class="form-control" id="parentContact" [(ngModel)]="formStudent.parent_contact" name="parentContact">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="parentEmail" class="form-label">Parent Email</label>
              <input type="email" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['parent_email']"
                     id="parentEmail" 
                     [(ngModel)]="formStudent.parent_email" 
                     name="parentEmail">
              <div class="invalid-feedback" *ngIf="formErrors['parent_email']">
                {{ formErrors['parent_email'] }}
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="submitAddStudent()" [disabled]="submitting">
          <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ submitting ? 'Adding...' : 'Add Student' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Edit Student Modal -->
<div class="modal fade" [class.show]="showEditModal" [style.display]="showEditModal ? 'block' : 'none'" *ngIf="showEditModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Edit Student: {{ selectedStudent?.first_name }} {{ selectedStudent?.last_name }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body">
        <form>
          <div class="row">
            <div class="col-md-4 mb-3">
              <label for="editStudentNumber" class="form-label">Student Number *</label>
              <input type="text" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['student_number']"
                     id="editStudentNumber" 
                     [(ngModel)]="formStudent.student_number" 
                     name="editStudentNumber" 
                     required>
              <div class="invalid-feedback" *ngIf="formErrors['student_number']">
                {{ formErrors['student_number'] }}
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label for="editFirstName" class="form-label">First Name *</label>
              <input type="text" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['first_name']"
                     id="editFirstName" 
                     [(ngModel)]="formStudent.first_name" 
                     name="editFirstName" 
                     required>
              <div class="invalid-feedback" *ngIf="formErrors['first_name']">
                {{ formErrors['first_name'] }}
              </div>
            </div>
            <div class="col-md-4 mb-3">
              <label for="editMiddleName" class="form-label">Middle Name</label>
              <input type="text" 
                     class="form-control" 
                     id="editMiddleName" 
                     [(ngModel)]="formStudent.middle_name" 
                     name="editMiddleName">
            </div>
            <div class="col-md-4 mb-3">
              <label for="editLastName" class="form-label">Last Name *</label>
              <input type="text" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['last_name']"
                     id="editLastName" 
                     [(ngModel)]="formStudent.last_name" 
                     name="editLastName" 
                     required>
              <div class="invalid-feedback" *ngIf="formErrors['last_name']">
                {{ formErrors['last_name'] }}
              </div>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editGradeLevel" class="form-label">Grade Level *</label>
              <select class="form-select" 
                      [class.is-invalid]="formErrors['grade_level']"
                      id="editGradeLevel" 
                      [(ngModel)]="formStudent.grade_level" 
                      name="editGradeLevel" 
                      required>
                <option *ngFor="let grade of gradeLevels" [value]="grade">Grade {{ grade }}</option>
              </select>
              <div class="invalid-feedback" *ngIf="formErrors['grade_level']">
                {{ formErrors['grade_level'] }}
              </div>
            </div>
            <div class="col-md-6 mb-3">
              <label for="editEnrollmentDate" class="form-label">Enrollment Date</label>
              <input type="date" class="form-control" id="editEnrollmentDate" [(ngModel)]="formStudent.enrollment_date" name="editEnrollmentDate" readonly>
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editDateOfBirth" class="form-label">Date of Birth</label>
              <input type="date" class="form-control" id="editDateOfBirth" [(ngModel)]="formStudent.date_of_birth" name="editDateOfBirth">
            </div>
            <div class="col-md-6 mb-3">
              <label for="editStatus" class="form-label">Status</label>
              <select class="form-select" id="editStatus" [(ngModel)]="formStudent.status" name="editStatus">
                <option value="active">Active</option>
                <option value="inactive">Inactive</option>
                <option value="graduated">Graduated</option>
              </select>
            </div>
          </div>
          <div class="row">
            <div class="col-md-12 mb-3">
              <label for="editAddress" class="form-label">Address</label>
              <input type="text" class="form-control" id="editAddress" [(ngModel)]="formStudent.address" name="editAddress">
            </div>
          </div>
          <hr class="my-4">
          <h6 class="text-muted mb-3">Parent/Guardian Information</h6>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editParentName" class="form-label">Parent/Guardian Name</label>
              <input type="text" class="form-control" id="editParentName" [(ngModel)]="formStudent.parent_name" name="editParentName">
            </div>
            <div class="col-md-6 mb-3">
              <label for="editParentContact" class="form-label">Parent Contact</label>
              <input type="text" class="form-control" id="editParentContact" [(ngModel)]="formStudent.parent_contact" name="editParentContact">
            </div>
          </div>
          <div class="row">
            <div class="col-md-6 mb-3">
              <label for="editParentEmail" class="form-label">Parent Email</label>
              <input type="email" 
                     class="form-control" 
                     [class.is-invalid]="formErrors['parent_email']"
                     id="editParentEmail" 
                     [(ngModel)]="formStudent.parent_email" 
                     name="editParentEmail">
              <div class="invalid-feedback" *ngIf="formErrors['parent_email']">
                {{ formErrors['parent_email'] }}
              </div>
            </div>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-primary" (click)="submitEditStudent()" [disabled]="submitting">
          <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ submitting ? 'Updating...' : 'Update' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- View Student Modal -->
<div class="modal fade" [class.show]="showViewModal" [style.display]="showViewModal ? 'block' : 'none'" *ngIf="showViewModal">
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Student Details: {{ getStudentFullName(selectedStudent!) }}
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedStudent">
        <div class="row">
          <div class="col-md-6">
            <h6 class="text-muted mb-3">Basic Information</h6>
            <p><strong>Student ID:</strong> {{ selectedStudent.student_number }}</p>
            <p><strong>Full Name:</strong> {{ getStudentFullName(selectedStudent) }}</p>
            <p><strong>Grade Level:</strong> {{ getGradeLevelText(selectedStudent.grade_level) }}</p>
            <p><strong>Date of Birth:</strong> {{ selectedStudent.date_of_birth ? formatDate(selectedStudent.date_of_birth) : 'Not provided' }}</p>
            <p><strong>Status:</strong> 
              <span class="badge ms-1" 
                    [class.bg-success]="selectedStudent.status === 'active'"
                    [class.bg-warning]="selectedStudent.status === 'inactive'"
                    [class.bg-secondary]="selectedStudent.status === 'graduated'">
                {{ selectedStudent.status | titlecase }}
              </span>
            </p>
            <p><strong>Address:</strong> {{ selectedStudent.address || 'Not provided' }}</p>
          </div>
          <div class="col-md-6">
            <h6 class="text-muted mb-3">Parent/Guardian Information</h6>
            <p><strong>Parent Name:</strong> {{ selectedStudent.parent_name || 'Not provided' }}</p>
            <p><strong>Parent Contact:</strong> {{ selectedStudent.parent_contact || 'Not provided' }}</p>
            <p><strong>Parent Email:</strong> {{ selectedStudent.parent_email || 'Not provided' }}</p>
            <hr>
            <h6 class="text-muted mb-3">System Information</h6>
            <p><strong>Enrollment Date:</strong> {{ formatDate(selectedStudent.enrollment_date) }}</p>
            <p><strong>Created:</strong> {{ formatDate(selectedStudent.created_at) }}</p>
            <p><strong>Last Updated:</strong> {{ formatDate(selectedStudent.updated_at) }}</p>
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Close</button>
        <button type="button" class="btn btn-primary" (click)="openEditModal(selectedStudent!)">
          Edit Student
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" [class.show]="showDeleteModal" [style.display]="showDeleteModal ? 'block' : 'none'" *ngIf="showDeleteModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          Confirm Delete
        </h5>
        <button type="button" class="btn-close" (click)="closeModals()"></button>
      </div>
      <div class="modal-body" *ngIf="selectedStudent">
        <p>Are you sure you want to delete the following student?</p>
        <div class="alert alert-warning">
          <strong>{{ getStudentFullName(selectedStudent) }}</strong><br>
          <small>Student ID: {{ selectedStudent.student_number }} | Grade: {{ selectedStudent.grade_level }}</small>
        </div>
        <p class="text-danger"><strong>Warning:</strong> This action cannot be undone.</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeModals()">Cancel</button>
        <button type="button" class="btn btn-danger" (click)="confirmDeleteStudent()" [disabled]="submitting">
          <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
          {{ submitting ? 'Deleting...' : 'Delete Student' }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Backdrop -->
<div class="modal-backdrop fade show" *ngIf="showAddModal || showEditModal || showViewModal || showDeleteModal || showUpgradeModal || showConfirmationModal" (click)="closeModals()"></div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
  <div *ngFor="let toast of toasts" 
       class="toast show align-items-center border-0 toast-animate" 
       [class.text-bg-success]="toast.type === 'success'"
       [class.text-bg-danger]="toast.type === 'error'"
       [class.text-bg-warning]="toast.type === 'warning'"
       [class.text-bg-info]="toast.type === 'info'"
       [class.toast-exit]="toast.isRemoving"
       role="alert">
    <div class="d-flex">
      <div class="toast-body">
        {{ toast.message }}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="removeToast(toast.id)"></button>
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal fade" [class.show]="showConfirmationModal" [style.display]="showConfirmationModal ? 'block' : 'none'" *ngIf="showConfirmationModal">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">
          {{ confirmationTitle }}
        </h5>
        <button type="button" class="btn-close" (click)="closeConfirmationModal()"></button>
      </div>
      <div class="modal-body">
        <p class="mb-0" style="white-space: pre-line;">{{ confirmationMessage }}</p>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" (click)="closeConfirmationModal()">Cancel</button>
        <button type="button" class="btn" [class]="confirmationButtonClass" (click)="executeConfirmationAction()">
          {{ confirmationButtonText }}
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Back Payment Confirmation Modal -->
<div class="modal fade" [class.show]="showBackPaymentModal" [style.display]="showBackPaymentModal ? 'block' : 'none'" *ngIf="showBackPaymentModal && backPaymentInfo">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content" style="max-height: 90vh;">
      <div class="modal-header bg-warning">
        <h5 class="modal-title">
          <i class="fas fa-exclamation-triangle me-2"></i>
          Confirm Upgrade with Back Payments
        </h5>
        <button type="button" class="btn-close" (click)="closeBackPaymentModal()"></button>
      </div>
      <div class="modal-body" style="max-height: calc(90vh - 130px); overflow-y: auto;">
        <div class="alert alert-warning">
          <h6><strong>{{ backPaymentInfo.student?.first_name }} {{ backPaymentInfo.student?.last_name }} has unpaid charges from Grade {{ backPaymentInfo.originalGrade }}</strong></h6>
          <p class="mb-2">
            Upgrading to Grade {{ backPaymentInfo.newGrade }} will create back payments for the following unpaid charges:
          </p>
        </div>
        
        <!-- New Back Payments Section -->
        <div class="card mb-3">
          <div class="card-header bg-warning">
            <h6 class="mb-0">
              <i class="fas fa-plus-circle me-2"></i>
              New Back Payments (from Grade {{ backPaymentInfo.originalGrade }})
            </h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>Charge</th>
                    <th>Type</th>
                    <th class="text-end">Amount Due</th>
                    <th class="text-end">Amount Paid</th>
                    <th class="text-end">Balance</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let charge of backPaymentInfo.unpaidCharges">
                    <td>{{ charge.charge_name }}</td>
                    <td>
                      <span class="badge bg-secondary">{{ charge.charge_type }}</span>
                    </td>
                    <td class="text-end">₱{{ charge.amount_due | number:'1.2-2' }}</td>
                    <td class="text-end">₱{{ charge.amount_paid | number:'1.2-2' }}</td>
                    <td class="text-end">
                      <strong>₱{{ (charge.amount_due - charge.amount_paid) | number:'1.2-2' }}</strong>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-warning">
                    <th colspan="4" class="text-end">New Back Payment Total:</th>
                    <th class="text-end">
                      <strong>₱{{ backPaymentInfo.totalAmount | number:'1.2-2' }}</strong>
                    </th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Existing Back Payments Section -->
        <div class="card mb-3" *ngIf="existingBackPayments.length > 0">
          <div class="card-header bg-info">
            <h6 class="mb-0">
              <i class="fas fa-history me-2"></i>
              Existing Back Payments (from previous grades)
              <span class="badge bg-dark ms-2">{{ existingBackPayments.length }}</span>
            </h6>
          </div>
          <div class="card-body">
            <div class="table-responsive">
              <table class="table table-sm">
                <thead>
                  <tr>
                    <th>From Grade</th>
                    <th>Charge</th>
                    <th class="text-end">Amount Due</th>
                    <th class="text-end">Amount Paid</th>
                    <th class="text-end">Balance</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let backPayment of existingBackPayments">
                    <td>Grade {{ backPayment.original_grade_level }}</td>
                    <td>{{ backPayment.charge_name }}</td>
                    <td class="text-end">₱{{ backPayment.amount_due | number:'1.2-2' }}</td>
                    <td class="text-end">₱{{ backPayment.amount_paid | number:'1.2-2' }}</td>
                    <td class="text-end">
                      <strong>₱{{ (backPayment.amount_due - backPayment.amount_paid) | number:'1.2-2' }}</strong>
                    </td>
                    <td>
                      <span class="badge" 
                            [class.bg-warning]="backPayment.status === 'pending'"
                            [class.bg-primary]="backPayment.status === 'partial'"
                            [class.bg-success]="backPayment.status === 'paid'">
                        {{ backPayment.status | titlecase }}
                      </span>
                    </td>
                  </tr>
                </tbody>
                <tfoot>
                  <tr class="table-info">
                    <th colspan="4" class="text-end">Existing Back Payments Total:</th>
                    <th class="text-end">
                      <strong>₱{{ getTotalOutstanding() | number:'1.2-2' }}</strong>
                    </th>
                    <th></th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Total Summary -->
        <div class="alert alert-primary" *ngIf="existingBackPayments.length > 0">
          <div class="row">
            <div class="col-md-6">
              <strong>Financial Summary:</strong>
              <ul class="mb-0 mt-2">
                <li>Existing back payments: ₱{{ getTotalOutstanding() | number:'1.2-2' }}</li>
                <li>New back payments: ₱{{ backPaymentInfo.totalAmount | number:'1.2-2' }}</li>
              </ul>
            </div>
            <div class="col-md-6 text-end">
              <h5 class="mb-0">
                <strong>Total Outstanding: ₱{{ (getTotalOutstanding() + backPaymentInfo.totalAmount) | number:'1.2-2' }}</strong>
              </h5>
            </div>
          </div>
        </div>
        
        <div class="alert alert-info">
          <strong>What happens next:</strong>
          <ul class="mb-0">
            <li>The student will be upgraded to Grade {{ backPaymentInfo.newGrade }}</li>
            <li>The unpaid charges will be recorded as back payments</li>
            <li *ngIf="existingBackPayments.length > 0">Existing back payments from previous grades will remain unchanged</li>
            <li>All back payments can be settled later through the payment system</li>
          </ul>
        </div>
        
        <div class="sticky-bottom bg-white pt-3">
          <p class="mb-0"><strong>Do you want to proceed with the upgrade?</strong></p>
        </div>
      </div>
      <div class="modal-footer bg-light border-top">
        <button type="button" class="btn btn-secondary" (click)="closeBackPaymentModal()">Cancel Upgrade</button>
        <button type="button" class="btn btn-warning" (click)="confirmBackPaymentUpgrade()">
          <i class="fas fa-arrow-up me-1"></i>
          Proceed with Upgrade
        </button>
      </div>
    </div>
  </div>
</div>
