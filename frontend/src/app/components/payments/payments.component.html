<div class="payments-container">
  <!-- Navigation Tabs -->
  <div class="card">
    <div class="card-header">
      <ul class="nav nav-tabs card-header-tabs" role="tablist">
        <li class="nav-item" role="presentation">
          <button class="nav-link" 
                  [class.active]="activeTab === 'create'"
                  (click)="switchTab('create')"
                  type="button" role="tab">
            Create Payment
          </button>
        </li>
        <li class="nav-item" role="presentation">
          <button class="nav-link"
                  [class.active]="activeTab === 'history'"
                  (click)="switchTab('history')"
                  type="button" role="tab">
            Payment History
            <span class="badge bg-primary ms-2" *ngIf="activeTab === 'history'">{{ payments.length }}</span>
          </button>
        </li>
      </ul>
    </div>

    <div class="card-body">
      <!-- Create Payment Tab -->
      <div class="tab-content">
        <div class="tab-pane fade" 
             [class.show]="activeTab === 'create'" 
             [class.active]="activeTab === 'create'" 
             *ngIf="activeTab === 'create'">
          
          <!-- Student Selection -->
          <div class="row mb-4">
            <div class="col-md-6">
              <label class="form-label">Select Student</label>
              <div class="d-flex gap-2">
                <div class="flex-grow-1 position-relative">
                  <div class="input-group">
                    <input type="text" 
                           class="form-control" 
                           [(ngModel)]="studentSearchInput"
                           (input)="onStudentSearchInput()"
                           (focus)="onStudentInputFocus()"
                           (blur)="onStudentInputBlur()"
                           placeholder="Type student name or number to search..."
                           [disabled]="studentsLoading"
                           autocomplete="off">
                    <button class="btn btn-outline-secondary" 
                            type="button" 
                            (click)="showAllStudents()"
                            [disabled]="studentsLoading"
                            title="Show all students">
                      <i class="fas fa-list"></i>
                    </button>
                  </div>
                  
                  <!-- Autocomplete Dropdown -->
                  <div class="dropdown-menu show w-100" 
                       *ngIf="showStudentDropdown && (filteredStudents.length > 0 || studentSearchInput.length > 0)"
                       style="position: absolute; top: 100%; z-index: 1000; max-height: 300px; overflow-y: auto;">
                    <button type="button" 
                            class="dropdown-item d-flex justify-content-between align-items-center"
                            *ngFor="let student of filteredStudents; let i = index"
                            (mousedown)="selectStudentFromDropdown(student)"
                            [class.active]="i === selectedDropdownIndex">
                      <div>
                        <div class="fw-bold">{{ getStudentFullName(student) }}</div>
                        <small class="text-muted">{{ student.student_number }} | Grade {{ student.grade_level }}</small>
                      </div>
                      <span class="badge bg-primary">{{ student.status | titlecase }}</span>
                    </button>
                    <div class="dropdown-item text-muted text-center" *ngIf="filteredStudents.length === 0 && studentSearchInput.length > 0">
                      <i class="fas fa-search me-2"></i>No students found
                    </div>
                  </div>
                  
                  <small class="form-text text-muted" *ngIf="!selectedStudent">
                    <i class="fas fa-info-circle me-1"></i>
                    Start typing to search for students
                  </small>
                  <small class="form-text text-success" *ngIf="selectedStudent">
                    <i class="fas fa-check-circle me-1"></i>
                    Selected: {{ getStudentFullName(selectedStudent) }}
                  </small>
                </div>
                <button class="btn btn-outline-danger" 
                        *ngIf="selectedStudent"
                        (click)="clearSelectedStudent()"
                        title="Clear selected student">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          </div>

          <!-- Student Charge Details -->
          <div *ngIf="selectedStudent && studentChargeBreakdown" class="mb-4">
            <div class="card bg-light">
              <div class="card-header">
                <h5 class="mb-0">
                  {{ getStudentFullName(selectedStudent) }} - Charge Summary
                  <span class="badge bg-primary ms-2">Grade {{ selectedStudent.grade_level }}</span>
                </h5>
              </div>
              <div class="card-body">
                <div class="row">
                  <div class="col-md-3">
                    <div class="text-center">
                      <h6 class="text-muted mb-1">Current Charges</h6>
                      <h4 class="text-primary">{{ formatCurrency(studentChargeBreakdown.summary.total_charges) }}</h4>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-center">
                      <h6 class="text-muted mb-1">Back Payments</h6>
                      <h4 class="text-warning">{{ formatCurrency(studentChargeBreakdown.summary.total_back_payments) }}</h4>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-center">
                      <h6 class="text-muted mb-1">Total Paid</h6>
                      <h4 class="text-success">{{ formatCurrency(studentChargeBreakdown.summary.total_payments) }}</h4>
                    </div>
                  </div>
                  <div class="col-md-3">
                    <div class="text-center">
                      <h6 class="text-muted mb-1">Remaining Balance</h6>
                      <h4 [class.text-danger]="studentChargeBreakdown.summary.remaining_balance > 0"
                          [class.text-success]="studentChargeBreakdown.summary.remaining_balance <= 0">
                        {{ formatCurrency(studentChargeBreakdown.summary.remaining_balance) }}
                      </h4>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Payment Form -->
          <div *ngIf="selectedStudent" class="row">
            <!-- Payment Details -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header">
                  <h5 class="mb-0">Payment Details</h5>
                </div>
                <div class="card-body">
                  <div class="mb-3">
                    <label for="paymentDate" class="form-label">Payment Date</label>
                    <input type="date" 
                           class="form-control" 
                           id="paymentDate"
                           [(ngModel)]="paymentForm.payment_date">
                  </div>
                  
                  <div class="mb-3">
                    <label for="paymentMethod" class="form-label">Payment Method</label>
                    <select class="form-select" 
                            id="paymentMethod"
                            [(ngModel)]="paymentForm.payment_method">
                      <option *ngFor="let method of paymentMethods" [value]="method.value">
                        {{ method.label }}
                      </option>
                    </select>
                  </div>
                  
                  <div class="mb-3" *ngIf="paymentForm.payment_method !== 'cash'">
                    <label for="referenceNumber" class="form-label">Reference Number</label>
                    <input type="text" 
                           class="form-control" 
                           id="referenceNumber"
                           [(ngModel)]="paymentForm.reference_number"
                           placeholder="Enter reference/transaction number">
                  </div>
                  
                  <div class="mb-3">
                    <label for="notes" class="form-label">Notes (Optional)</label>
                    <textarea class="form-control" 
                              id="notes"
                              rows="3"
                              [(ngModel)]="paymentForm.notes"
                              placeholder="Additional notes..."></textarea>
                  </div>
                </div>
              </div>
            </div>

            <!-- Payment Items -->
            <div class="col-md-6">
              <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                  <h5 class="mb-0">Payment Items</h5>
                  <button class="btn btn-sm btn-outline-primary" 
                          (click)="addManualCharge()">
                    Add Manual Charge
                  </button>
                </div>
                <div class="card-body" style="max-height: 400px; overflow-y: auto;">
                  <div *ngIf="paymentForm.items.length === 0" class="text-center text-muted py-3">
                    <p>No payment items available</p>
                    <small>Click "Add Manual Charge" to add custom charges</small>
                  </div>
                  
                  <div *ngFor="let item of paymentForm.items; let i = index" class="mb-3 p-3 border rounded">
                    <div class="d-flex justify-content-between align-items-start mb-2">
                      <div class="flex-grow-1">
                        <div class="fw-bold">{{ item.description }}</div>
                        <small class="text-muted" *ngIf="!item.is_manual_charge">
                          Type: {{ item.charge_type || 'N/A' }}
                        </small>
                      </div>
                      <button class="btn btn-sm btn-outline-danger" 
                              (click)="removePaymentItem(i)"
                              title="Remove item">
                        <i class="fas fa-times"></i>
                      </button>
                    </div>
                    
                    <div class="row" *ngIf="item.is_manual_charge">
                      <div class="col-12 mb-2">
                        <input type="text" 
                               class="form-control form-control-sm" 
                               [(ngModel)]="item.description"
                               placeholder="Charge description">
                      </div>
                    </div>
                    
                    <div class="row">
                      <div class="col-12">
                        <label class="form-label form-label-sm">Amount to Pay</label>
                        <div class="input-group input-group-sm">
                          <span class="input-group-text">â‚±</span>
                          <input type="number" 
                                 class="form-control" 
                                 [(ngModel)]="item.amount"
                                 min="0"
                                 step="0.01"
                                 placeholder="0.00">
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
                <div class="card-footer">
                  <div class="d-flex justify-content-between align-items-center">
                    <strong>Total Payment:</strong>
                    <h5 class="mb-0 text-primary">{{ formatCurrency(getTotalPaymentAmount()) }}</h5>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Print Option -->
          <div *ngIf="selectedStudent" class="row mt-3">
            <div class="col-12">
              <div class="form-check">
                <input class="form-check-input" 
                       type="checkbox" 
                       id="printInvoiceAfterPayment"
                       [(ngModel)]="paymentForm.printInvoiceAfterPayment">
                <label class="form-check-label" for="printInvoiceAfterPayment">
                  <i class="fas fa-print me-1"></i>
                  Print invoice receipt immediately after payment processing
                </label>
              </div>
            </div>
          </div>

          <!-- Payment Actions -->
          <div *ngIf="selectedStudent" class="row mt-4">
            <div class="col-12">
              <div class="d-flex justify-content-end gap-2">
                <button class="btn btn-outline-secondary" 
                        (click)="resetPaymentForm()"
                        [disabled]="submitting">
                  Reset Form
                </button>
                <button class="btn btn-success" 
                        (click)="processPayment()"
                        [disabled]="submitting || getTotalPaymentAmount() <= 0">
                  <span *ngIf="submitting" class="spinner-border spinner-border-sm me-2"></span>
                  {{ submitting ? 'Processing...' : 'Process Payment' }}
                </button>
              </div>
            </div>
          </div>

          <!-- Loading State -->
          <div *ngIf="studentsLoading || studentChargesLoading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading student information...</p>
          </div>

          <!-- Error State -->
          <div *ngIf="error" class="alert alert-danger" role="alert">
            {{ error }}
          </div>
        </div>

        <!-- Payment History Tab -->
        <div class="tab-pane fade" 
             [class.show]="activeTab === 'history'" 
             [class.active]="activeTab === 'history'" 
             *ngIf="activeTab === 'history'">
          
          <!-- Payment History Filters -->
          <div class="row mb-4">
            <div class="col-md-4">
              <label for="paymentSearch" class="form-label">Search Payments</label>
              <input type="text" 
                     class="form-control" 
                     id="paymentSearch"
                     [(ngModel)]="paymentSearchTerm"
                     (input)="onPaymentSearch()"
                     placeholder="Search by student name or reference...">
            </div>
            <div class="col-md-2">
              <label for="paymentDateFilter" class="form-label">Date</label>
              <input type="date" 
                     class="form-control" 
                     id="paymentDateFilter"
                     [(ngModel)]="selectedPaymentDateFilter"
                     (change)="applyPaymentFilters()">
            </div>
            <div class="col-md-2">
              <label for="paymentMethodFilter" class="form-label">Method</label>
              <select class="form-select" 
                      id="paymentMethodFilter"
                      [(ngModel)]="selectedPaymentMethodFilter"
                      (change)="applyPaymentFilters()">
                <option value="">All Methods</option>
                <option *ngFor="let method of paymentMethods" [value]="method.value">
                  {{ method.label }}
                </option>
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">&nbsp;</label>
              <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary" (click)="clearPaymentFilters()">
                  Clear Filters
                </button>
                <button class="btn btn-primary" (click)="loadPayments()">
                  Refresh
                </button>
              </div>
            </div>
          </div>

          <!-- Payment History Table -->
          <div *ngIf="!loading && payments.length > 0" class="table-responsive">
            <table class="table table-striped table-hover">
              <thead class="table-dark">
                <tr>
                  <th>Invoice #</th>
                  <th>Date</th>
                  <th>Student</th>
                  <th>Amount</th>
                  <th>Method</th>
                  <th>Reference</th>
                  <th>Created By</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let payment of payments">
                  <td>
                    <span *ngIf="payment.invoice_number" class="fw-bold text-primary">{{ payment.invoice_number }}</span>
                    <span *ngIf="!payment.invoice_number" class="text-muted">-</span>
                  </td>
                  <td>{{ payment.payment_date | date:'mediumDate' }}</td>
                  <td>
                    <div>
                      <strong>{{ payment.first_name }} {{ payment.last_name }}</strong>
                      <br>
                      <small class="text-muted">{{ payment.student_number }}</small>
                    </div>
                  </td>
                  <td>
                    <span class="fw-bold text-success">{{ formatCurrency(payment.total_amount) }}</span>
                  </td>
                  <td>
                    <span class="badge bg-primary">{{ payment.payment_method | titlecase }}</span>
                  </td>
                  <td>
                    <span *ngIf="payment.reference_number">{{ payment.reference_number }}</span>
                    <span *ngIf="!payment.reference_number" class="text-muted">-</span>
                  </td>
                  <td>
                    <small>{{ payment.created_by_username }}</small>
                  </td>
                  <td>
                    <button class="btn btn-sm btn-outline-primary me-1" 
                            title="View Details">
                      View
                    </button>
                    <button class="btn btn-sm btn-outline-success" 
                            (click)="printInvoice(payment)"
                            title="Print Invoice">
                      <i class="fas fa-print"></i>
                    </button>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Loading State -->
          <div *ngIf="loading" class="text-center py-4">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Loading...</span>
            </div>
            <p class="mt-2 text-muted">Loading payment history...</p>
          </div>

          <!-- No Data State -->
          <div *ngIf="!loading && payments.length === 0" class="text-center py-5">
            <div class="text-muted">
              <i class="fas fa-money-bill-wave fa-3x mb-3"></i>
              <h5>No Payments Found</h5>
              <p>No payment records are available yet.</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Student Selector Modal -->
<div class="modal fade" 
     [class.show]="showStudentSelector" 
     [style.display]="showStudentSelector ? 'block' : 'none'" 
     *ngIf="showStudentSelector">
  <div class="modal-dialog modal-lg" style="max-height: 90vh; margin: 5vh auto;">
    <div class="modal-content" style="height: 100%; display: flex; flex-direction: column;">
      <div class="modal-header" style="flex-shrink: 0;">
        <h5 class="modal-title">Select Student</h5>
        <button type="button" class="btn-close" (click)="showStudentSelector = false"></button>
      </div>
      <div class="modal-body" style="flex: 1; overflow-y: auto;">
        <!-- Student Search -->
        <div class="mb-3">
          <input type="text" 
                 class="form-control" 
                 [(ngModel)]="studentSearchTerm"
                 (input)="onStudentSearch()"
                 placeholder="Search students by name or student number...">
        </div>

        <!-- Students List -->
        <div *ngIf="!studentsLoading && filteredStudents.length > 0">
          <div class="list-group">
            <button type="button" 
                    class="list-group-item list-group-item-action"
                    *ngFor="let student of filteredStudents"
                    (click)="selectStudent(student)">
              <div class="d-flex justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">{{ getStudentFullName(student) }}</h6>
                  <small class="text-muted">{{ student.student_number }} | Grade {{ student.grade_level }}</small>
                </div>
                <span class="badge bg-primary">{{ student.status | titlecase }}</span>
              </div>
            </button>
          </div>
        </div>

        <!-- Loading State -->
        <div *ngIf="studentsLoading" class="text-center py-4">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
          </div>
          <p class="mt-2 text-muted">Loading students...</p>
        </div>

        <!-- No Students Found -->
        <div *ngIf="!studentsLoading && filteredStudents.length === 0" class="text-center py-4">
          <div class="text-muted">
            <i class="fas fa-users fa-3x mb-3"></i>
            <h5>No Students Found</h5>
            <p *ngIf="studentSearchTerm">No students match your search criteria.</p>
            <p *ngIf="!studentSearchTerm">No active students available.</p>
          </div>
        </div>
      </div>
      <div class="modal-footer" style="flex-shrink: 0;">
        <button type="button" class="btn btn-secondary" (click)="showStudentSelector = false">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 11000;">
  <div *ngFor="let toast of toasts" 
       class="toast show align-items-center border-0 toast-animate" 
       [class.text-bg-success]="toast.type === 'success'"
       [class.text-bg-danger]="toast.type === 'error'"
       [class.text-bg-warning]="toast.type === 'warning'"
       [class.text-bg-info]="toast.type === 'info'"
       [class.toast-exit]="toast.isRemoving"
       role="alert">
    <div class="d-flex">
      <div class="toast-body">
        {{ toast.message }}
      </div>
      <button type="button" class="btn-close btn-close-white me-2 m-auto" (click)="removeToast(toast.id)"></button>
    </div>
  </div>
</div>
